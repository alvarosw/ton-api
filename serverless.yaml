service: ton-api
useDotenv: true

provider:
  name: aws
  runtime: nodejs16.x
  stage: dev
  tags: 
    name: ton-api
    stage: dev
  region: us-east-1
  environment:
    USERS_TABLE: ${self:custom.usersTableName}
    COUNTER_API_URL: ${env:COUNTER_API_URL, 'https://api.countapi.xyz'}
    COUNTER_NAMESPACE: ${env:COUNTER_NAMESPACE, 'ton-site.com'}
    COUNTER_KEY: ${env:COUNTER_KEY, 'visits'}
    JWT_SECRET: ${env:JWT_SECRET, 'supersecret'}

custom:
  usersTableName: ton-users-table-${self:provider.stage}

plugins:
  - serverless-iam-roles-per-function
  - serverless-dotenv-plugin
  - serverless-offline

functions:
  - ${file(./src/middleware/middleware-configs.yml)}
  - ${file(./src/functions/auth/auth-functions.yml)}
  - ${file(./src/functions/users/users-functions.yml)}
  - ${file(./src/functions/visits/visits-functions.yml)}

resources:
  Resources:
    UsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.usersTableName}
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
